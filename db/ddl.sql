BEGIN;

# Drop old tables
DROP TABLE IF EXISTS CLASS_ALIAS;
DROP TABLE IF EXISTS SKIN;
DROP TABLE IF EXISTS SKIN_IMPORT;
DROP TABLE IF EXISTS SKIN_FILE;
DROP TABLE IF EXISTS SKIN_FILE_VERSION;
DROP TABLE IF EXISTS TARGET;
DROP TABLE IF EXISTS SCHEDULED_TASK;

# Drop VERSION columns
ALTER TABLE ACTION DROP COLUMN VERSION;
ALTER TABLE GROUPS DROP COLUMN VERSION;
ALTER TABLE GROUP_USER DROP COLUMN VERSION;
ALTER TABLE PERMISSION DROP COLUMN VERSION;
ALTER TABLE ROLE DROP COLUMN VERSION;
ALTER TABLE SITE_ALIAS DROP COLUMN VERSION;

# Alter SITE
ALTER TABLE SITE
DROP COLUMN VERSION,
DROP COLUMN SERVER_ADDRESS,
DROP COLUMN SERVER_PORT,
DROP COLUMN SERVER_SCHEME,
DROP COLUMN SERVER_NAME;

# Alter APP
ALTER TABLE APP
DROP COLUMN VERSION,
DROP COLUMN FILTER_NAMES,
DROP COLUMN AUTHENTICATION_REQUIRED;

# Alter SITE_APP
ALTER TABLE SITE_APP
DROP COLUMN VERSION,
DROP COLUMN URI_PATTERN,
DROP COLUMN DEFAULT_APP,
DROP COLUMN ENABLED;

# Alter USER
ALTER TABLE USER
DROP COLUMN VERSION,
MODIFY COLUMN PASSWORD VARCHAR(40),
DROP COLUMN SUPER_USER,
ADD COLUMN USER_TYPE int(11) default NULL,
ADD COLUMN API_VERSION_ID bigint(20) default NULL,
ADD INDEX API_VERSION_ID_IND USING BTREE(API_VERSION_ID);

# Alter ITEM
ALTER TABLE ITEM
DROP INDEX VALID_FROM_IND,
CHANGE VALID_FROM START_DATE DATETIME,
CHANGE COLUMN AMOUNT_PER_MONTH AMOUNT DECIMAL(21,6) DEFAULT NULL,
ADD INDEX START_DATE_IND USING BTREE(START_DATE),
ADD COLUMN END_DATE DATETIME DEFAULT NULL,
ADD INDEX END_DATE_IND USING BTREE(END_DATE);

# Alter ALGORITHM
ALTER TABLE ALGORITHM
MODIFY COLUMN ITEM_DEFINITION_ID BIGINT (20) NULL,
ADD COLUMN TYPE VARCHAR(3) NOT NULL,
ADD COLUMN ALGORITHM_CONTEXT_ID bigint(20) default NULL,
ADD INDEX ALGORITHM_CONTEXT_ID_IND USING BTREE(ALGORITHM_CONTEXT_ID);

# Alter ENVIRONMENT
ALTER TABLE ENVIRONMENT
DROP COLUMN VERSION,
ADD COLUMN ITEMS_PER_FEED int(11) NOT NULL,
ADD COLUMN OWNER varchar(255) default NULL;

# Alter ITEM_VALUE
ALTER TABLE ITEM_VALUE
CHANGE COLUMN `VALUE` `VALUE` mediumtext,
ADD COLUMN UNIT varchar(255) default NULL,
ADD COLUMN PER_UNIT varchar(255) default NULL,
ADD COLUMN START_DATE DATETIME DEFAULT NULL,
ADD INDEX START_DATE_IND USING BTREE(START_DATE),
ADD COLUMN END_DATE DATETIME DEFAULT NULL,
ADD INDEX END_DATE_IND USING BTREE(END_DATE);

# Alter ITEM_VALUE_DEFINITION
ALTER TABLE ITEM_VALUE_DEFINITION
ADD COLUMN UNIT varchar(255) default NULL,
ADD COLUMN PER_UNIT varchar(255) default NULL,
ADD COLUMN ALIASED_TO_ID bigint(20) default NULL,
ADD INDEX ALIASED_TO_IND USING BTREE(ALIASED_TO_ID);

# Create ITEM_VALUE_DEFINITION_API_VERSION
CREATE TABLE IF NOT EXISTS ITEM_VALUE_DEFINITION_API_VERSION (
  ITEM_VALUE_DEFINITION_ID bigint(20) NOT NULL,
  API_VERSION_ID bigint(20) NOT NULL,
  PRIMARY KEY  USING BTREE (ITEM_VALUE_DEFINITION_ID,API_VERSION_ID),
  KEY API_VERSION_ID_IND (API_VERSION_ID),
  KEY ITEM_VALUE_DEFINITION_ID_IND (ITEM_VALUE_DEFINITION_ID)
);

# Create API_VERSION
CREATE TABLE IF NOT EXISTS API_VERSION (
  ID bigint(20) NOT NULL auto_increment,
  CREATED datetime default NULL,
  MODIFIED datetime default NULL,
  UID varchar(12) NOT NULL,
  VERSION varchar(3) default NULL,
  PRIMARY KEY  (ID),
  UNIQUE KEY UID (UID)
);

# Create STATUS
ALTER TABLE ACTION ADD COLUMN STATUS INT(11) NOT NULL;
ALTER TABLE ALGORITHM ADD COLUMN STATUS INT(11) NOT NULL;
ALTER TABLE API_VERSION ADD COLUMN STATUS INT(11) NOT NULL;
ALTER TABLE APP ADD COLUMN STATUS INT(11) NOT NULL;
# ALTER TABLE DATA_CATEGORY ADD COLUMN STATUS INT(11) NOT NULL;
ALTER TABLE ENVIRONMENT ADD COLUMN STATUS INT(11) NOT NULL;
ALTER TABLE GROUPs ADD COLUMN STATUS INT(11) NOT NULL;
ALTER TABLE GROUP_USER ADD COLUMN STATUS INT(11) NOT NULL;
# ALTER TABLE ITEM ADD COLUMN STATUS INT(11) NOT NULL;
ALTER TABLE ITEM_DEFINITION ADD COLUMN STATUS INT(11) NOT NULL;
# ALTER TABLE ITEM_VALUE ADD COLUMN STATUS INT(11) NOT NULL;
ALTER TABLE ITEM_VALUE_DEFINITION ADD COLUMN STATUS INT(11) NOT NULL;
ALTER TABLE PERMISSION ADD COLUMN STATUS INT(11) NOT NULL;
# ALTER TABLE PROFILE ADD COLUMN STATUS INT(11) NOT NULL;
ALTER TABLE ROLE ADD COLUMN STATUS INT(11) NOT NULL;
ALTER TABLE SITE ADD COLUMN STATUS INT(11) NOT NULL;
ALTER TABLE SITE_APP ADD COLUMN STATUS INT(11) NOT NULL;
# ALTER TABLE USER ADD COLUMN STATUS INT(11) NOT NULL;
ALTER TABLE VALUE_DEFINITION ADD COLUMN STATUS INT(11) NOT NULL;

COMMIT;
