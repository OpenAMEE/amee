BEGIN;

# Drop old tables
DROP TABLE IF EXISTS CLASS_ALIAS;
DROP TABLE IF EXISTS SKIN;
DROP TABLE IF EXISTS SKIN_IMPORT;
DROP TABLE IF EXISTS SKIN_FILE;
DROP TABLE IF EXISTS SKIN_FILE_VERSION;
DROP TABLE IF EXISTS TARGET;

# Drop VERSION columns
ALTER TABLE ACTION DROP COLUMN VERSION;
ALTER TABLE APP DROP COLUMN VERSION;
ALTER TABLE ENVIRONMENT DROP COLUMN VERSION;
ALTER TABLE GROUPS DROP COLUMN VERSION;
ALTER TABLE GROUP_USER DROP COLUMN VERSION;
ALTER TABLE PERMISSION DROP COLUMN VERSION;
ALTER TABLE ROLE DROP COLUMN VERSION;
ALTER TABLE SITE DROP COLUMN VERSION;
ALTER TABLE SCHEDULED_TASK DROP COLUMN VERSION;
ALTER TABLE SITE_ALIAS DROP COLUMN VERSION;
ALTER TABLE SITE_APP DROP COLUMN VERSION;
ALTER TABLE TARGET DROP COLUMN VERSION;
ALTER TABLE USER DROP COLUMN VERSION;

# Alter SITE
ALTER TABLE SITE DROP COLUMN SERVER_NAME;
ALTER TABLE SITE DROP INDEX SERVER_NAME_IND;
ALTER TABLE SITE DROP COLUMN SERVER_ADDRESS;
ALTER TABLE SITE DROP COLUMN ERVER_PORT;
ALTER TABLE SITE DROP COLUMN SERVER_SCHEME;

# Alter APP
ALTER TABLE APP DROP COLUMN FILTER_NAMES;
ALTER TABLE APP DROP COLUMN AUTHENTICATION_REQUIRED;

# Alter SITE_APP
ALTER TABLE APP DROP COLUMN URI_PATTERN;
ALTER TABLE APP DROP COLUMN DEFAULT_APP;
ALTER TABLE APP DROP COLUMN ENABLED;

# Alter USER
ALTER TABLE USER MODIFY COLUMN PASSWORD VARCHAR(40);
ALTER TABLE USER DROP COLUMN SUPER_USER;
ALTER TABLE USER ADD COLUMN NICK_NAME VARCHAR(255) default NULL;
ALTER TABLE USER ADD COLUMN LOCATION VARCHAR(255) default NULL;
ALTER TABLE USER ADD COLUMN USER_TYPE int(11) default NULL;
ALTER TABLE USER ADD COLUMN API_VERSION_ID bigint(20) default NULL;
ALTER TABLE USER ADD INDEX API_VERSION_ID_IND USING BTREE(API_VERSION_ID);

# Alter ITEM
ALTER TABLE ITEM DROP INDEX VALID_FROM_IND;
ALTER TABLE ITEM CHANGE VALID_FROM START_DATE DATETIME;
ALTER TABLE ITEM CHANGE COLUMN AMOUNT_PER_MONTH AMOUNT DECIMAL(18,3) DEFAULT NULL;
ALTER TABLE ITEM ADD INDEX START_DATE_IND USING BTREE(START_DATE);
ALTER TABLE ITEM ADD COLUMN END_DATE DATETIME DEFAULT NULL;
ALTER TABLE ITEM ADD INDEX END_DATE_IND USING BTREE(END_DATE);

# Alter ALGORITHM
ALTER TABLE ALGORITHM MODIFY COLUMN ITEM_DEFINITION_ID BIGINT (20) NULL;
ALTER TABLE ALGORITHM ADD COLUMN TYPE VARCHAR(3) NOT NULL;
ALTER TABLE ALGORITHM ADD COLUMN ALGORITHM_CONTEXT_ID bigint(20) default NULL;
ALTER TABLE ALGORITHM ADD INDEX ALGORITHM_CONTEXT_ID_IND USING BTREE(ALGORITHM_CONTEXT_ID);

# Alter ENVIRONMENT
ALTER TABLE ENVIRONMENT ADD COLUMN ITEMS_PER_FEED int(11) NOT NULL;
ALTER TABLE ENVIRONMENT ADD COLUMN OWNER varchar(255) default NULL;

# Alter ITEM_VALUE
ALTER TABLE ITEM_VALUE ADD COLUMN UNIT varchar(255) default NULL;
ALTER TABLE ITEM_VALUE ADD COLUMN PER_UNIT varchar(255) default NULL;

# Alter ITEM_VALUE_DEFINITION
ALTER TABLE ITEM_VALUE_DEFINITION ADD COLUMN UNIT varchar(255) default NULL;
ALTER TABLE ITEM_VALUE_DEFINITION ADD COLUMN PER_UNIT varchar(255) default NULL;
ALTER TABLE ITEM_VALUE_DEFINITION ADD COLUMN ALIASED_TO_ID bigint(20) default NULL;
ALTER TABLE ITEM_VALUE_DEFINITION ADD INDEX ALIASED_TO_IND USING BTREE(ALIASED_TO_ID);

# Create ITEM_VALUE_DEFINITION_API_VERSION
CREATE TABLE IF NOT EXISTS ITEM_VALUE_DEFINITION_API_VERSION (
  ITEM_VALUE_DEFINITION_ID bigint(20) NOT NULL,
  API_VERSION_ID bigint(20) NOT NULL,
  PRIMARY KEY  USING BTREE (ITEM_VALUE_DEFINITION_ID,API_VERSION_ID),
  KEY API_VERSION_ID_IND (API_VERSION_ID),
  KEY ITEM_VALUE_DEFINITION_ID_IND (ITEM_VALUE_DEFINITION_ID)
);

# Create API_VERSION
CREATE TABLE IF NOT EXISTS API_VERSION (
  ID bigint(20) NOT NULL auto_increment,
  CREATED datetime default NULL,
  MODIFIED datetime default NULL,
  UID varchar(12) NOT NULL,
  VERSION varchar(3) default NULL,
  PRIMARY KEY  (ID),
  UNIQUE KEY UID (UID)
);

COMMIT;