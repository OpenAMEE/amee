<?xml version="1.0" encoding="UTF-8"?>

<deployment xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="urn:jboss:bean-deployer bean-deployer_1_0.xsd"
            xmlns="urn:jboss:bean-deployer">
    <bean name="Naming" class="org.jnp.server.SingletonNamingServer"/>

    <bean name="InitialContextProperties" class="java.util.Hashtable">
        <constructor>
            <parameter class="java.util.Map">
                <map keyClass="java.lang.String" valueClass="java.lang.String">
                    <entry>
                        <key>java.naming.factory.initial</key>
                        <value>org.jnp.interfaces.LocalOnlyContextFactory</value>
                    </entry>
                    <entry>
                        <key>java.naming.factory.url.pkgs</key>
                        <value>org.jboss.naming:org.jnp.interfaces</value>
                    </entry>
                </map>
            </parameter>
        </constructor>
    </bean>

    <bean name="java:comp/Initializer" class="org.jboss.ejb3.embedded.JavaCompInitializer">
        <property name="jndiProperties">
            <inject bean="InitialContextProperties"/>
        </property>
    </bean>

    <bean name="XidFactory" class="org.jboss.tm.XidFactoryImpl"/>

    <bean name="XidFactoryMBean" class="org.jboss.ejb3.embedded.XidFactoryMBean">
        <constructor>
            <parameter class="org.jboss.tm.XidFactoryBase">
                <inject bean="XidFactory"/>
            </parameter>
        </constructor>
    </bean>

    <bean name="TransactionManagerInitializer" class="org.jboss.tm.TransactionManagerInitializer">
        <property name="xidFactory">
            <inject bean="XidFactory"/>
        </property>
        <property name="initialContextProperties">
            <inject bean="InitialContextProperties"/>
        </property>
        <!-- 2 minutes in seconds -->
        <property name="transactionTimeout">120</property>
    </bean>

    <bean name="UserTransaction" class="org.jboss.ejb3.embedded.UserTransactionImpl">
        <demand>TransactionManagerInitializer</demand>
    </bean>

    <bean name="UserTransactionBinding" class="org.jboss.ejb3.embedded.JndiBinder">
        <property name="jndiProperties">
            <inject bean="InitialContextProperties"/>
        </property>
        <property name="target">
            <inject bean="UserTransaction"/>
        </property>
        <property name="bindTo">UserTransaction</property>
        <property name="serializable">false</property>
    </bean>

    <bean name="TransactionManager" class="java.lang.Object">
        <constructor factoryMethod="getTransactionManager">
            <factory bean="TransactionManagerInitializer"/>
        </constructor>
    </bean>
    <bean name="CachedConnectionManager" class="org.jboss.resource.connectionmanager.CachedConnectionManagerReference">
        <property name="transactionManager">
            <inject bean="TransactionManager"/>
        </property>
    </bean>

    <!--
       <bean class="org.jboss.jdbc.HypersonicDatabase"
         name="jboss:service=Hypersonic,database=localDB">
         <property name="database">localDB</property>
         <property name="inProcessMode">true</property>
         <property name="dbDataDir">.</property>
       </bean>
    -->

    <!-- 1000 * 1 = 1 second = 1,000 -->
    <!-- 1000 * 60 * 4 = 4 minutes = 240,000 -->
    <bean name="EngineDSBootstrap" class="org.jboss.resource.adapter.jdbc.local.LocalTxDataSource">
        <property name="driverClass">com.mysql.jdbc.Driver</property>
        <property name="connectionURL">jdbc:mysql://localhost/carbon?validationQuery=SELECT+1&amp;minEvictableIdleTimeMillis=240000&amp;timeBetweenEvictionRunsMillis=1000&amp;testOnBorrow=true&amp;testWhileIdle=true&amp;autoReconnectForPools=true&amp;useCompression=true</property>
        <property name="userName">carbon</property>
        <property name="password">carbon</property>
        <property name="jndiName">java:/EngineDS</property>
        <property name="minSize">20</property>
        <property name="maxSize">200</property>
        <property name="blockingTimeout">1000</property>
        <property name="idleTimeout">240000</property>
        <property name="checkValidConnectionSQL">select count(*) from dual</property>
        <property name="exceptionSorterClassName">com.mysql.jdbc.integration.jboss.ExtendedMysqlExceptionSorter</property>
        <property name="validConnectionCheckerClassName">com.mysql.jdbc.integration.jboss.MysqlValidConnectionChecker</property>
        <property name="transactionManager">
            <inject bean="TransactionManager"/>
        </property>
        <property name="cachedConnectionManager">
            <inject bean="CachedConnectionManager"/>
        </property>
        <property name="initialContextProperties">
            <inject bean="InitialContextProperties"/>
        </property>
    </bean>

    <bean name="EngineDS" class="java.lang.Object">
        <constructor factoryMethod="getDatasource">
            <factory bean="EngineDSBootstrap"/>
        </constructor>
    </bean>

</deployment>