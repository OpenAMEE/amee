<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
                           http://www.springframework.org/schema/util
                           http://www.springframework.org/schema/util/spring-util-2.5.xsd">

    <bean id="mlApplication" class="org.restlet.Application">
        <property name="root" ref="default"/>
        <property name="tunnelService.methodTunnel" value="true"/>
    </bean>

    <bean id="default" class="org.restlet.ext.spring.SpringRouter">
        <property name="attachments">
            <map>
                <entry key="" value-ref="mlRouter"/>
            </map>
        </property>
    </bean>
    <bean id="default.context" class="org.springframework.beans.factory.config.PropertyPathFactoryBean"/>

    <bean id="mlRouter" class="org.restlet.ext.spring.SpringRouter">
        <property name="attachments">
            <map>
                <entry key="">
                    <bean class="org.restlet.ext.spring.SpringFinder">
                        <lookup-method name="createResource" bean="homeResource"/>
                    </bean>
                </entry>
                <entry key="/auth">
                    <bean class="org.restlet.ext.spring.SpringFinder">
                        <lookup-method name="createResource" bean="authResource"/>
                    </bean>
                </entry>
                <entry key="/you">
                    <bean class="ml.restlet.auth.AuthGuard">
                        <constructor-arg index="0" ref="default.context"/>
                        <constructor-arg index="1" ref="org.restlet.data.ChallengeScheme.CUSTOM"/>
                        <constructor-arg index="2" value="ML"/>
                        <property name="next" ref="youRouter"/>
                    </bean>
                </entry>
                <entry key="/conversations">
                    <bean class="ml.restlet.auth.AuthGuard">
                        <constructor-arg index="0" ref="default.context"/>
                        <constructor-arg index="1" ref="org.restlet.data.ChallengeScheme.CUSTOM"/>
                        <constructor-arg index="2" value="ML"/>
                        <property name="next" ref="conversationsRouter"/>
                    </bean>
                </entry>
                <entry key="/people">
                    <bean class="ml.restlet.auth.AuthGuard">
                        <constructor-arg index="0" ref="default.context"/>
                        <constructor-arg index="1" ref="org.restlet.data.ChallengeScheme.CUSTOM"/>
                        <constructor-arg index="2" value="ML"/>
                        <property name="superOnly" value="true"/>
                        <property name="next" ref="peopleRouter"/>
                    </bean>
                </entry>
            </map>
        </property>
    </bean>

    <bean id="youRouter" class="org.restlet.ext.spring.SpringRouter">
        <property name="attachments">
            <map>
                <entry key="">
                    <bean class="org.restlet.ext.spring.SpringFinder">
                        <lookup-method name="createResource" bean="youResource"/>
                    </bean>
                </entry>
            </map>
        </property>
    </bean>

    <bean id="conversationsRouter" class="org.restlet.ext.spring.SpringRouter">
        <property name="attachments">
            <map>
                <entry key="">
                    <bean class="org.restlet.ext.spring.SpringFinder">
                        <lookup-method name="createResource" bean="conversationsResource"/>
                    </bean>
                </entry>
                <entry key="/{conversationId}">
                    <bean class="ml.restlet.conversations.ConversationFilter">
                        <property name="next">
                            <bean class="org.restlet.ext.spring.SpringFinder">
                                <lookup-method name="createResource" bean="conversationResource"/>
                            </bean>
                        </property>
                    </bean>
                </entry>
            </map>
        </property>
    </bean>

    <bean id="peopleRouter" class="org.restlet.ext.spring.SpringRouter">
        <property name="attachments">
            <map>
                <entry key="">
                    <bean class="org.restlet.ext.spring.SpringFinder">
                        <lookup-method name="createResource" bean="peopleResource"/>
                    </bean>
                </entry>
                <entry key="/{personId}">
                    <bean class="ml.restlet.people.PersonFilter">
                        <property name="next">
                            <bean class="org.restlet.ext.spring.SpringFinder">
                                <lookup-method name="createResource" bean="personResource"/>
                            </bean>
                        </property>
                    </bean>
                </entry>
            </map>
        </property>
    </bean>

    <bean id="org.restlet.data.ChallengeScheme.CUSTOM"
          class="org.springframework.beans.factory.config.FieldRetrievingFactoryBean"/>

</beans>
